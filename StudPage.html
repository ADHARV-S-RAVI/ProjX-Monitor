<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjX Student Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN for easy icon replacement -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar styling for chat window */
        .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #d1d5db #f3f4f6; }
        .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .scrollbar-none::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50/50 font-sans text-gray-900 selection:bg-indigo-100 selection:text-indigo-900">
    <div id="app">
        <!-- Application content loads here -->
        <div class="h-screen flex items-center justify-center text-gray-500">Loading Dashboard...</div>
    </div>

    <script>
        // --- CONSTANTS ---
        const apiKey = "AIzaSyB3fARHsKcLO-z1lpxnHVwuc-LaXXDmde0";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";

        const STUDENT_DATABASE = [
            { srn: "24SUUBECS0047", name: "ADHARV S RAVI", section: "3CSE01" },
            { srn: "24SUUBECS0045", name: "ADARSH SHUKLA", section: "3CSE01" },
            { srn: "24SUUBECS0046", name: "ADARSH V", section: "3CSE01" },
            { srn: "24SUUBECS0048", name: "ADITHI SRIKANTH SHASTRY", section: "3CSE01" },
            { srn: "24SUUBECS0049", name: "ADITHYA KARANTH S", section: "3CSE01" },
            { srn: "24SUUBECS0051", name: "ADITHYA N C", section: "3CSE01" },
            { srn: "24SUUBECS0001", name: "A MOHITH SANTOSH", section: "3CSE01" },
            { srn: "24SUUBELCS001", name: "ABHISHEK N J", section: "Lateral" },
            { srn: "24SUUBELCS002", name: "ADARSH B H", section: "Lateral" },
            { srn: "24SUUBELCS003", name: "AKASH GOWDA S", section: "Lateral" }
        ];

        const DEADLINE = new Date(Date.now() + 5 * 24 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000); 
        const SUBJECTS = ["Web Technology", "IOT", "OOP", "AIML"];

        const SUBJECT_DETAILS = {
            "Web Technology": {
                faculty: "Prof. Vijayalakshmi H R",
                topic: "MERN Stack E-Commerce Platform",
                guidelines: ["Must use React for Frontend and Node/Express for Backend.", "Database must be MongoDB.", "Responsive UI (Tailwind CSS recommended).", "Include Authentication (JWT)."]
            },
            "IOT": {
                faculty: "Prof. D S Rakesh Gowda",
                topic: "Smart Home Automation System",
                guidelines: ["Must use Arduino or Raspberry Pi.", "Sensors data must be logged to a cloud dashboard.", "Includes hardware demonstration.", "Mobile app control is mandatory."]
            },
            "OOP": {
                faculty: "Prof. Prabodh CP",
                topic: "Bank Management System",
                guidelines: ["Language: Java or C++.", "Must demonstrate Inheritance, Polymorphism, and Encapsulation.", "File handling for data persistence.", "Console or GUI based interface."]
            },
            "AIML": {
                faculty: "Dr. Bhagya Nair",
                topic: "Stock Price Prediction Model",
                guidelines: ["Language: Python.", "Libraries: Pandas, Scikit-learn, TensorFlow.", "Dataset must be pre-processed and cleaned.", "Minimum model accuracy: 85%."]
            }
        };

        const MOCK_RANKINGS = [
            { rank: 1, team: "Alpha Squad", project: "AI Tutor", time: "2h ago" },
            { rank: 2, team: "Code Ninjas", project: "FinTech App", time: "5h ago" },
            { rank: 3, team: "Pixel Perfect", project: "AR Map", time: "1d ago" },
            { rank: 4, team: "Data Dynamos", project: "MediCare", time: "1d ago" },
            { rank: 5, team: "Cyber Sentinels", project: "NetGuard", time: "2d ago" },
        ];

        const INITIAL_MARKS = {
            presentation: 18, assignment: 9, ppt: 9, report: 17, total: 53, maxTotal: 60
        };

        // Helper function to create DOM elements
        const createEl = (tag, attrs = {}, children) => {
            const el = document.createElement(tag);
            
            // --- FIX: Normalize children to an array ---
            const childArray = Array.isArray(children) 
                ? children 
                : (children !== undefined && children !== null ? [children] : []);
            // ------------------------------------------

            for (const key in attrs) {
                if (key.startsWith('on') && typeof attrs[key] === 'function') {
                    el.addEventListener(key.substring(2).toLowerCase(), attrs[key]);
                } else if (key === 'className') {
                    el.className = attrs[key];
                } else if (key === 'dangerouslySetInnerHTML' && attrs[key].__html) {
                    el.innerHTML = attrs[key].__html;
                } else {
                    el.setAttribute(key, attrs[key]);
                }
            }
            
            childArray.forEach(child => {
                if (typeof child === 'string') {
                    el.appendChild(document.createTextNode(child));
                } else if (child instanceof Node) {
                    el.appendChild(child);
                }
            });
            return el;
        };

        // --- LOGIN VALIDATION ---
        function validateLogin() {
            const storedUser = sessionStorage.getItem('currentUser');
            if (!storedUser) {
                // Redirect to login if no session exists
                window.location.href = 'index.html';
                return null;
            }
            try {
                return JSON.parse(storedUser);
            } catch (e) {
                window.location.href = 'index.html';
                return null;
            }
        }

        const loggedInUser = validateLogin();

        // --- GLOBAL STATE ---
        let appState = {
            activeTab: 'dashboard',
            selectedSubject: "Web Technology",
            currentUser: loggedInUser || STUDENT_DATABASE[0],
            isAIRequestOpen: false,
            aiInitialPrompt: "",
            aiInput: "", // Added initialization for aiInput
            // Team formation state (Initial state uses the current user)
            teamName: (loggedInUser || STUDENT_DATABASE[0]).name + "'s Project",
            members: [{ id: 1, name: (loggedInUser || STUDENT_DATABASE[0]).name, identifier: (loggedInUser || STUDENT_DATABASE[0]).srn, isLead: true }],
            newSrn: "",
            addError: "",
            projectType: "Individual",
            // Submission state (Mock history)
            submissionHistory: [
                { id: 1, action: "Assignment Uploaded", timestamp: "Oct 10, 2:30 PM", status: "Verified" },
                { id: 2, action: "Report Draft 1", timestamp: "Nov 02, 10:15 AM", status: "Pending" }
            ],
            // AI Chat State
            chatMessages: [{ 
                role: 'assistant', 
                text: `Hi! I'm your ProjX Mentor for ${SUBJECTS[0]}. How can I help you with "${SUBJECT_DETAILS[SUBJECTS[0]].topic}" today?` 
            }],
            isAILoading: false,
        };

        // --- STATE & RENDER MANAGEMENT ---
        const setState = (newState) => {
            Object.assign(appState, newState);
            renderApp();
        };

        const setActiveTab = (tabId) => {
            setState({ activeTab: tabId });
        };

        const setSelectedSubject = (subject) => {
            const subjectInfo = SUBJECT_DETAILS[subject];
            const initialMessage = { 
                role: 'assistant', 
                text: `Hi! I'm your ProjX Mentor for ${subject}. How can I help you with "${subjectInfo.topic}" today?` 
            };
            setState({ 
                selectedSubject: subject, 
                chatMessages: [initialMessage] // Reset chat on subject change
            });
        };

        const handleOpenAI = (prompt = "") => {
            setState({ 
                aiInitialPrompt: prompt, 
                isAIRequestOpen: true 
            });
            // If there's a prompt, trigger send logic after chat window opens
            if (prompt) {
                setTimeout(() => handleSend(prompt), 10); 
            }
        };

        // --- API CALL FUNCTION ---
        const callGeminiAPI = async (prompt, systemInstruction = "") => {
            try {
                let currentRetries = 0;
                const maxRetries = 3;

                while (currentRetries < maxRetries) {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                systemInstruction: { parts: [{ text: systemInstruction }] }
                            }),
                        }
                    );

                    if (response.status === 429 && currentRetries < maxRetries - 1) {
                        const delay = Math.pow(2, currentRetries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        currentRetries++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't generate a response. Please try again.";
                }
                return "Error: Maximum retries exceeded for API call.";

            } catch (error) {
                console.error("Gemini API Error:", error);
                return "Error connecting to AI service. Please try again later.";
            }
        };


        // --- COMPONENTS (as functions returning DOM elements) ---

        // ----------------------------------------------------
        // 1. Navigation
        // ----------------------------------------------------
        const Navigation = ({ activeTab, userName }) => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                { id: 'team', label: 'Team Formation', icon: 'users' },
                { id: 'submissions', label: 'Submissions', icon: 'upload' },
                { id: 'marks', label: 'Marks', icon: 'trophy' },
                { id: 'profile', label: 'Profile', icon: 'bar-chart-3' },
            ];

            return createEl('nav', { className: 'bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm backdrop-blur-md bg-opacity-90' }, [
                createEl('div', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8' }, [
                    createEl('div', { className: 'flex justify-between h-16' }, [
                        createEl('div', { className: 'flex items-center' }, [
                            createEl('div', { 
                                className: 'flex-shrink-0 flex items-center gap-2 group cursor-pointer', 
                                onclick: () => setActiveTab('dashboard') 
                            }, [
                                createEl('div', { className: 'w-9 h-9 bg-indigo-600 rounded-lg flex items-center justify-center shadow-md group-hover:scale-110 transition-transform duration-200' }, [
                                    createEl('span', { className: 'text-white font-bold text-lg' }, 'X')
                                ]),
                                createEl('span', { className: 'font-bold text-xl text-gray-900 tracking-tight group-hover:text-indigo-600 transition-colors' }, 'ProjX Monitor')
                            ])
                        ]),
                        createEl('div', { className: 'hidden sm:flex sm:items-center sm:space-x-8' }, navItems.map(item => 
                            createEl('button', {
                                key: item.id,
                                onclick: () => setActiveTab(item.id),
                                className: `${
                                    activeTab === item.id
                                        ? 'border-indigo-500 text-indigo-600 bg-indigo-50/50'
                                        : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 hover:bg-gray-50'
                                } inline-flex items-center px-3 pt-1 border-b-2 text-sm font-medium h-full transition-all duration-200`
                            }, [
                                createEl('i', { 
                                    'data-lucide': item.icon, 
                                    className: `w-4 h-4 mr-2 ${activeTab === item.id ? 'animate-bounce' : ''}`, 
                                    style: `animation-duration: 2s;` 
                                }),
                                createEl('span', {}, item.label)
                            ])
                        )),
                        createEl('div', { className: 'flex items-center gap-4' }, [
                            createEl('div', { className: 'h-9 w-9 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold border border-indigo-200 cursor-pointer hover:bg-indigo-200 transition-colors shadow-sm' }, 
                                userName.charAt(0)
                            ),
                            createEl('button', { 
                                onclick: () => {
                                    if (confirm('Are you sure you want to logout?')) {
                                        sessionStorage.removeItem('currentUser');
                                        window.location.replace('index.html');
                                    }
                                },
                                className: 'p-2 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-50 transition-colors',
                                title: 'Logout'
                            }, [
                                createEl('i', { 'data-lucide': 'log-out', className: 'w-5 h-5' })
                            ])
                        ])
                    ])
                ])
            ]);
        };

        // ----------------------------------------------------
        // 2. AI Assistant (Chat Logic)
        // ----------------------------------------------------
        const handleSend = async (text) => {
            const { chatMessages, selectedSubject } = appState;
            const subjectInfo = SUBJECT_DETAILS[selectedSubject];
            
            const messageToSend = text || document.getElementById('ai-input').value;

            if (!messageToSend.trim()) return;

            const newMessages = [...chatMessages, { role: 'user', text: messageToSend }];
            setState({ chatMessages: newMessages, isAILoading: true, aiInitialPrompt: "" }); // Clear input field

            const systemContext = `
                You are an expert academic mentor for a Computer Science student project.
                Current Subject: ${selectedSubject}
                Project Topic: ${subjectInfo.topic}
                Mandatory Guidelines: ${subjectInfo.guidelines.join(". ")}
                
                Your goal is to help the student structure their project, suggest technologies, fix code concepts, or draft documentation.
                Keep answers concise, encouraging, and technically accurate. Use formatting like bullet points or code blocks for clarity.
            `;

            const aiResponse = await callGeminiAPI(messageToSend, systemContext);
            
            const updatedMessages = [...appState.chatMessages.filter(m => m.role !== 'temp'), { role: 'assistant', text: aiResponse }];
            
            setState({ 
                chatMessages: updatedMessages, 
                isAILoading: false,
                aiInitialPrompt: "", // Ensure prompt is cleared after use
            });

            // Scroll to bottom after response
            setTimeout(() => {
                const messagesArea = document.getElementById('messages-area');
                if (messagesArea) messagesArea.scrollTop = messagesArea.scrollHeight;
                lucide.createIcons(); // Re-initialize icons
            }, 50);
        };

        const AIAssistant = () => {
            const { isAIRequestOpen, selectedSubject, chatMessages, isAILoading } = appState;
            const subjectInfo = SUBJECT_DETAILS[selectedSubject];
            
            const setIsOpen = (val) => setState({ isAIRequestOpen: val });
            const setInput = (e) => setState({ aiInput: e.target.value });

            // Quick Action Prompts
            const suggestions = [
                { label: "Generate Roadmap", prompt: `Create a 4-week project roadmap for my topic: ${subjectInfo.topic}` },
                { label: "Draft Abstract", prompt: `Write a professional project abstract for my topic: ${subjectInfo.topic}` },
                { label: "Tech Stack", prompt: `What are the best libraries/tools to use for the ${selectedSubject} project?` }
            ];

            if (!isAIRequestOpen) return (
                createEl('button', {
                    onclick: () => setIsOpen(true),
                    className: "fixed bottom-6 right-6 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-transform duration-200 z-50 flex items-center justify-center group"
                }, [
                    createEl('div', { className: "absolute inset-0 bg-white rounded-full opacity-0 group-hover:animate-ping" }),
                    createEl('i', { 'data-lucide': 'sparkles', className: 'w-6 h-6 animate-pulse' }),
                    createEl('span', { className: "absolute -top-10 right-0 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap" }, 'Ask AI Mentor')
                ])
            );
            
            setTimeout(() => {
                const messagesArea = document.getElementById('messages-area');
                if (messagesArea) messagesArea.scrollTop = messagesArea.scrollHeight;
                lucide.createIcons(); // Re-initialize icons
            }, 50);


            return createEl('div', { className: "fixed bottom-6 right-6 w-96 h-[500px] bg-white rounded-2xl shadow-2xl border border-gray-200 flex flex-col z-50 animate-in slide-in-from-bottom-10 fade-in duration-300" }, [
                // Header
                createEl('div', { className: "bg-gradient-to-r from-indigo-600 to-purple-600 p-4 rounded-t-2xl flex justify-between items-center text-white" }, [
                    createEl('div', { className: "flex items-center gap-2" }, [
                        createEl('i', { 'data-lucide': 'bot', className: 'w-6 h-6' }),
                        createEl('div', {}, [
                            createEl('h3', { className: "font-bold text-sm" }, 'ProjX AI Mentor'),
                            createEl('p', { className: "text-[10px] opacity-80 flex items-center gap-1" }, [
                                createEl('span', { className: "w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse" }),
                                'Online • ', selectedSubject
                            ])
                        ])
                    ]),
                    createEl('button', { onclick: () => setIsOpen(false), className: "hover:bg-white/20 p-1 rounded-full transition-colors" }, [
                        createEl('i', { 'data-lucide': 'x', className: 'w-5 h-5' })
                    ])
                ]),
                // Messages Area
                createEl('div', { id: 'messages-area', className: "flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 scrollbar-thin scrollbar-thumb-gray-300" }, [
                    ...chatMessages.map((msg, idx) => 
                        createEl('div', { key: idx, className: `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}` }, [
                            createEl('div', {
                                className: `max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed ${
                                    msg.role === 'user' 
                                        ? 'bg-indigo-600 text-white rounded-br-none' 
                                        : 'bg-white border border-gray-200 text-gray-800 rounded-bl-none shadow-sm'
                                }`
                            }, [
                                createEl('div', { 
                                    dangerouslySetInnerHTML: { 
                                        __html: msg.text.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                                    } 
                                })
                            ])
                        ])
                    ),
                    isAILoading && createEl('div', { className: "flex justify-start" }, [
                        createEl('div', { className: "bg-white border border-gray-200 p-3 rounded-2xl rounded-bl-none shadow-sm flex items-center gap-2" }, [
                            createEl('i', { 'data-lucide': 'loader-2', className: 'w-4 h-4 animate-spin text-indigo-600' }),
                            createEl('span', { className: "text-xs text-gray-500" }, 'Thinking...')
                        ])
                    ]),
                    // Scroll anchor - not needed if we manage scroll manually
                ]),
                // Suggestions
                chatMessages.length === 1 && createEl('div', { className: "px-4 pb-2 flex gap-2 overflow-x-auto scrollbar-none" }, 
                    suggestions.map((s) => 
                        createEl('button', {
                            key: s.label,
                            onclick: () => handleSend(s.prompt),
                            className: "flex-shrink-0 bg-indigo-50 text-indigo-700 text-xs px-3 py-1.5 rounded-full border border-indigo-100 hover:bg-indigo-100 transition-colors whitespace-nowrap"
                        }, [`✨ ${s.label}`])
                    )
                ),
                // Input Area
                createEl('div', { className: "p-3 border-t border-gray-100 bg-white rounded-b-2xl" }, [
                    createEl('form', {
                        onsubmit: (e) => { e.preventDefault(); handleSend(); },
                        className: "flex items-center gap-2"
                    }, [
                        createEl('input', {
                            id: 'ai-input',
                            type: 'text', 
                            value: appState.aiInput || '',
                            oninput: setInput,
                            placeholder: "Ask for help...",
                            className: "flex-1 bg-gray-100 text-gray-900 text-sm rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        }),
                        createEl('button', {
                            type: 'submit', 
                            disabled: isAILoading || !appState.aiInput,
                            className: "bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                        }, [
                            createEl('i', { 'data-lucide': 'send', className: 'w-4 h-4' })
                        ])
                    ])
                ])
            ]);
        };

        // ----------------------------------------------------
        // 3. Page Content
        // ----------------------------------------------------
        
        const WelcomeBanner = ({ userName }) => {
            const getGreeting = () => {
                const hour = new Date().getHours();
                if (hour < 12) return 'Good Morning';
                if (hour < 18) return 'Good Afternoon';
                return 'Good Evening';
            };
            return createEl('div', { className: "bg-gradient-to-r from-gray-900 to-indigo-900 rounded-2xl p-8 mb-6 text-white relative overflow-hidden shadow-2xl hover:scale-[1.01] transition-transform duration-300" }, [
                createEl('div', { className: "absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl -mt-10 -mr-10 animate-pulse" }),
                createEl('div', { className: "relative z-10" }, [
                    createEl('div', { className: "flex items-center gap-2 text-indigo-300 mb-2 font-medium" }, [
                        createEl('i', { 'data-lucide': 'sparkles', className: 'w-4 h-4' }),
                        createEl('span', {}, `${getGreeting()}, Student`)
                    ]),
                    createEl('h1', { className: "text-4xl font-bold mb-2 tracking-tight" }, `Welcome back, ${userName}`),
                    createEl('p', { className: "text-gray-300 max-w-xl" }, 'You are on track with your submissions. Check your team\'s progress and upcoming deadlines below.')
                ])
            ]);
        };

        const DueTimer = () => {
            const calculateTimeLeft = () => {
                const difference = DEADLINE - new Date();
                if (difference > 0) {
                    return {
                        days: Math.floor(difference / (1000 * 60 * 60 * 24)),
                        hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
                        minutes: Math.floor((difference / 1000 / 60) % 60),
                        seconds: Math.floor((difference / 1000) % 60),
                    };
                }
                return { days: 0, hours: 0, minutes: 0, seconds: 0 };
            };

            let timeLeft = calculateTimeLeft();
            
            // This component will not update automatically like in React.
            // I'll manage the time update separately outside the main render loop.
            
            return createEl('div', { 
                id: 'due-timer-card', 
                className: "bg-white rounded-2xl p-6 shadow-lg border border-indigo-100 mb-8 relative overflow-hidden group hover:shadow-xl transition-all duration-300" 
            }, [
                createEl('div', { className: "absolute top-0 left-0 w-1 h-full bg-indigo-600" }),
                createEl('div', { className: "flex flex-col md:flex-row items-center justify-between gap-4" }, [
                    createEl('div', { className: "flex items-center gap-4" }, [
                        createEl('div', { className: "p-3 bg-indigo-50 rounded-xl group-hover:bg-indigo-100 transition-colors" }, [
                            createEl('i', { 'data-lucide': 'clock', className: 'w-8 h-8 text-indigo-600' })
                        ]),
                        createEl('div', {}, [
                            createEl('h2', { className: "text-xl font-bold text-gray-900" }, 'Final Submission Deadline'),
                            createEl('p', { className: "text-gray-500 text-sm" }, 'Time remaining to upload all deliverables')
                        ])
                    ]),
                    createEl('div', { id: 'timer-display', className: "flex gap-3" }, 
                        Object.entries(timeLeft).map(([unit, value]) => 
                            createEl('div', { key: unit, className: "flex flex-col items-center" }, [
                                createEl('div', { 'data-unit': unit, className: "bg-gray-900 text-white rounded-lg w-16 h-16 flex items-center justify-center text-2xl font-bold font-mono shadow-md group-hover:bg-indigo-600 transition-colors duration-300" }, String(value).padStart(2, '0')),
                                createEl('span', { className: "text-xs uppercase font-semibold text-gray-500 mt-2 tracking-wide" }, unit)
                            ])
                        )
                    )
                ])
            ]);
        };
        
        // Interval function to update the timer every second (independent of state render)
        const updateTimer = () => {
            const timerDisplay = document.getElementById('timer-display');
            if (!timerDisplay) return;

            const difference = DEADLINE - new Date();
            if (difference <= 0) {
                clearInterval(window.timerInterval);
                return;
            }

            const timeLeft = {
                days: Math.floor(difference / (1000 * 60 * 60 * 24)),
                hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
                minutes: Math.floor((difference / 1000 / 60) % 60),
                seconds: Math.floor((difference / 1000) % 60),
            };

            Object.entries(timeLeft).forEach(([unit, value]) => {
                const element = timerDisplay.querySelector(`[data-unit="${unit}"]`);
                if (element) {
                    element.textContent = String(value).padStart(2, '0');
                }
            });
        };

        const Leaderboard = () => createEl('div', { className: "bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow duration-300" }, [
            createEl('div', { className: "p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50/50" }, [
                createEl('h3', { className: "text-lg font-bold text-gray-900 flex items-center gap-2" }, [
                    createEl('i', { 'data-lucide': 'trophy', className: 'w-5 h-5 text-yellow-500' }),
                    'Live Rankings'
                ]),
                createEl('span', { className: "text-xs font-bold bg-green-100 text-green-700 px-3 py-1 rounded-full flex items-center gap-1 shadow-sm" }, [
                    createEl('span', { className: "w-2 h-2 rounded-full bg-green-600 animate-pulse" }),
                    'Live'
                ])
            ]),
            createEl('div', { className: "overflow-x-auto" }, [
                createEl('table', { className: "w-full text-left text-sm" }, [
                    createEl('thead', { className: "bg-gray-50 text-gray-500 font-semibold uppercase tracking-wider text-xs" }, [
                        createEl('tr', {}, [
                            createEl('th', { className: "px-6 py-4" }, 'Rank'),
                            createEl('th', { className: "px-6 py-4" }, 'Team Name'),
                            createEl('th', { className: "px-6 py-4" }, 'Project'),
                            createEl('th', { className: "px-6 py-4 text-right" }, 'Submission'),
                        ])
                    ]),
                    createEl('tbody', { className: "divide-y divide-gray-100" }, 
                        MOCK_RANKINGS.map((team) => createEl('tr', { key: team.rank, className: "hover:bg-gray-50 transition-colors group cursor-default" }, [
                            createEl('td', { className: "px-6 py-4" }, [
                                createEl('span', { className: `inline-flex items-center justify-center w-8 h-8 rounded-full font-bold shadow-sm transition-transform group-hover:scale-110 ${
                                    team.rank === 1 ? 'bg-yellow-100 text-yellow-700 border border-yellow-200' : 
                                    team.rank === 2 ? 'bg-gray-200 text-gray-700 border border-gray-300' :
                                    team.rank === 3 ? 'bg-orange-100 text-orange-700 border border-orange-200' : 'text-gray-500 bg-gray-50'
                                }` }, String(team.rank))
                            ]),
                            createEl('td', { className: "px-6 py-4 font-semibold text-gray-900 group-hover:text-indigo-600 transition-colors" }, team.team),
                            createEl('td', { className: "px-6 py-4 text-gray-500" }, team.project),
                            createEl('td', { className: "px-6 py-4 text-right text-gray-400 font-mono text-xs" }, team.time)
                        ]))
                    )
                ])
            ])
        ]);

        const TeamFormation = ({ currentUser, onOpenAI }) => {
            const { selectedSubject, teamName, members, newSrn, addError, projectType } = appState;
            const subjectInfo = SUBJECT_DETAILS[selectedSubject];

            const setTeamName = (e) => setState({ teamName: e.target.value });
            const setNewSrn = (e) => setState({ newSrn: e.target.value, addError: "" });
            const setProjectType = (type) => {
                let updatedMembers = members;
                if (type === "Individual") {
                    updatedMembers = members.slice(0, 1); // Keep only the lead (current user)
                }
                setState({ projectType: type, members: updatedMembers, addError: "" });
            };

            const addMember = () => {
                // If currently in Individual mode, switch to Group so the user can add members
                if (projectType === "Individual") {
                    setState({ projectType: "Group", addError: "Switched to Group mode — enter SRN to add members." });
                    setTimeout(() => {
                        const input = document.getElementById('new-srn-input');
                        if (input) input.focus();
                    }, 60);
                    return;
                }

                if (!newSrn) {
                    setState({ addError: "Please enter an SRN to add." });
                    return;
                }

                if (members.length >= 4) {
                    setState({ addError: "Max team size (4) reached." });
                    return;
                }

                const student = STUDENT_DATABASE.find(s => s.srn.toUpperCase() === newSrn.toUpperCase());
                if (student) {
                    if (members.some(m => m.identifier === student.srn)) {
                        setState({ addError: "Student already in team." });
                        return;
                    }
                    setState({ 
                        members: [...members, { id: Date.now(), name: student.name, identifier: student.srn, isLead: false }],
                        newSrn: "",
                        addError: ""
                    });
                } else {
                    setState({ addError: "SRN not found in university database." });
                }
            };

            const removeMember = (id) => {
                setState({ members: members.filter(m => m.id !== id) });
            };

            return createEl('div', { className: "grid lg:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500" }, [
                createEl('div', { className: "lg:col-span-2 space-y-6" }, [
                    // Project Setup Card
                    createEl('div', { className: "bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow" }, [
                        createEl('h3', { className: "text-lg font-bold text-gray-900 mb-4 flex items-center gap-2 pb-2 border-b border-gray-100" }, [
                            createEl('i', { 'data-lucide': 'book-open', className: 'w-5 h-5 text-indigo-600' }), 'Subject & Project Type'
                        ]),
                        createEl('div', { className: "grid md:grid-cols-2 gap-6" }, [
                            createEl('div', {}, [
                                createEl('label', { className: "block text-sm font-semibold text-gray-700 mb-2" }, 'Select Subject'),
                                createEl('div', { className: "relative" }, [
                                    createEl('select', { 
                                        value: selectedSubject, 
                                        onchange: (e) => setSelectedSubject(e.target.value),
                                        className: "w-full rounded-lg border-gray-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm outline-none appearance-none cursor-pointer"
                                    }, SUBJECTS.map(sub => createEl('option', { key: sub, value: sub }, sub))),
                                    createEl('i', { 'data-lucide': 'briefcase', className: 'w-4 h-4 text-gray-400 absolute right-3 top-3 pointer-events-none'})
                                ])
                            ]),
                            createEl('div', {}, [
                                createEl('label', { className: "block text-sm font-semibold text-gray-700 mb-2" }, 'Project Mode'),
                                createEl('div', { className: "flex bg-gray-100 p-1 rounded-lg" }, [
                                    createEl('button', { 
                                        onclick: () => setProjectType("Individual"),
                                        className: `flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all duration-200 ${projectType === "Individual" ? "bg-white text-indigo-600 shadow-sm transform scale-105" : "text-gray-500 hover:text-gray-700"}`
                                    }, 'Individual'),
                                    createEl('button', { 
                                        onclick: () => setProjectType("Group"),
                                        className: `flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all duration-200 ${projectType === "Group" ? "bg-white text-indigo-600 shadow-sm transform scale-105" : "text-gray-500 hover:text-gray-700"}`
                                    }, 'Group')
                                ])
                            ])
                        ])
                    ]),
                    // Dynamic Teacher & Guidelines Card
                    subjectInfo && createEl('div', { className: "bg-gradient-to-br from-white to-blue-50 rounded-xl border border-blue-100 p-6 shadow-sm hover:shadow-md transition-all relative overflow-hidden" }, [
                        createEl('div', { className: "relative z-10" }, [
                            createEl('h3', { className: "text-lg font-bold text-gray-900 mb-4 flex items-center gap-2" }, [
                                createEl('i', { 'data-lucide': 'graduation-cap', className: 'w-6 h-6 text-indigo-600' }), 'Course Guidelines & Allocation'
                            ]),
                            createEl('div', { className: "grid md:grid-cols-2 gap-6 mb-4" }, [
                                createEl('div', { className: "bg-white p-4 rounded-xl border border-gray-100 shadow-sm" }, [
                                    createEl('p', { className: "text-xs font-bold text-gray-500 uppercase tracking-wide mb-1" }, 'Course Faculty'),
                                    createEl('p', { className: "text-lg font-bold text-indigo-900" }, subjectInfo.faculty)
                                ]),
                                createEl('div', { className: "bg-white p-4 rounded-xl border border-gray-100 shadow-sm" }, [
                                    createEl('p', { className: "text-xs font-bold text-gray-500 uppercase tracking-wide mb-1" }, 'Allotted Topic'),
                                    createEl('p', { className: "text-lg font-bold text-indigo-700" }, subjectInfo.topic)
                                ])
                            ]),
                            createEl('div', { className: "bg-white/60 rounded-lg p-4 border border-blue-100 mb-4" }, [
                                createEl('p', { className: "text-sm font-bold text-gray-700 mb-3 flex items-center gap-2" }, [
                                    createEl('i', { 'data-lucide': 'file-warning', className: 'w-4 h-4 text-orange-500'}), 'Mandatory Guidelines'
                                ]),
                                createEl('ul', { className: "space-y-2" }, subjectInfo.guidelines.map((guide, idx) => 
                                    createEl('li', { key: idx, className: "flex items-start gap-3 text-sm text-gray-600" }, [
                                        createEl('span', { className: "mt-1.5 w-1.5 h-1.5 rounded-full bg-indigo-400 flex-shrink-0" }), guide
                                    ])
                                ))
                            ]),
                            // AI Feature Integration
                            createEl('button', { 
                                onclick: () => onOpenAI(`Create a detailed weekly project roadmap for my topic: ${subjectInfo.topic}`),
                                className: "w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 font-semibold group"
                            }, [
                                createEl('i', { 'data-lucide': 'sparkles', className: 'w-5 h-5 group-hover:animate-spin' }), 'Generate AI Project Roadmap'
                            ])
                        ])
                    ]),
                    // Team Details Card
                    createEl('div', { className: "bg-white rounded-xl shadow-sm border border-gray-200 p-6" }, [
                        createEl('h3', { className: "text-lg font-bold text-gray-900 mb-4 flex items-center gap-2" }, [
                            createEl('i', { 'data-lucide': 'users', className: 'w-5 h-5 text-indigo-600' }), 'Team Composition'
                        ]),
                        createEl('div', { className: "mb-6" }, [
                            createEl('label', { className: "block text-sm font-semibold text-gray-700 mb-2" }, 'Team Name'),
                            createEl('input', { 
                                type: "text", 
                                value: teamName,
                                placeholder: projectType === "Individual" ? `${currentUser.name}'s Project` : "Enter Creative Team Name",
                                oninput: setTeamName,
                                className: "w-full rounded-lg border-gray-300 border p-2 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                            })
                        ]),
                        createEl('div', { className: "space-y-4" }, [
                            createEl('div', { className: "flex justify-between items-center" }, [
                                createEl('label', { className: "block text-sm font-semibold text-gray-700" }, 'Add Team Members'),
                                projectType === "Individual" && createEl('span', { className: "text-xs font-medium text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-100 animate-pulse" }, 'Individual Mode Active')
                            ]),
                            createEl('div', { className: "flex gap-2" }, [
                                createEl('input', { 
                                    id: 'new-srn-input',
                                    type: "text", 
                                    placeholder: "Search by SRN (e.g., 24SUUBECS0045)",
                                    value: newSrn,
                                    onfocus: () => { if (projectType === "Individual") { setState({ projectType: "Group", addError: "Switched to Group mode — enter SRN to add members." }); } },
                                    oninput: setNewSrn,
                                    className: "flex-1 rounded-lg border-gray-300 border p-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                                }),
                                createEl('button', { 
                                    onclick: addMember,
                                    title: projectType === "Individual" ? "Switch to Group mode to add members" : "Add Member",
                                    className: "bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2 transition-colors font-medium text-sm shadow-sm active:transform active:scale-95"
                                }, [
                                    createEl('i', { 'data-lucide': 'user-plus', className: 'w-4 h-4' }), projectType === "Individual" ? 'Switch to Group' : 'Add Member'
                                ])
                            ]),
                            addError && createEl('p', { className: "text-sm text-red-500 flex items-center gap-1 animate-bounce" }, [createEl('i', { 'data-lucide': 'alert-circle', className: 'w-3 h-3' }), addError])
                        ]),
                        createEl('div', { className: "mt-6 space-y-3" }, [
                            createEl('h4', { className: "text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3" }, `Roster (${members.length}/4)`),
                            ...members.map((member) => createEl('div', { key: member.id, className: "flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 group hover:border-indigo-300 hover:shadow-sm transition-all duration-300" }, [
                                createEl('div', { className: "flex items-center gap-3" }, [
                                    createEl('div', { className: `w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${member.isLead ? 'bg-indigo-600 text-white' : 'bg-white border-2 border-indigo-100 text-indigo-600'}` }, member.name.charAt(0)),
                                    createEl('div', {}, [
                                        createEl('p', { className: "font-semibold text-gray-900 flex items-center gap-2 text-sm" }, [
                                            member.name,
                                            member.isLead && createEl('span', { className: "text-[10px] bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-200 font-bold" }, 'LEAD')
                                        ]),
                                        createEl('p', { className: "text-xs text-gray-500" }, member.identifier)
                                    ])
                                ]),
                                !member.isLead && createEl('button', { 
                                    onclick: () => removeMember(member.id),
                                    className: "text-gray-400 hover:text-red-500 transition-colors p-2 hover:bg-red-50 rounded-full"
                                }, [createEl('i', { 'data-lucide': 'trash-2', className: 'w-4 h-4' })])
                            ]))
                        ])
                    ])
                ]),
                // Sidebar - Quick Guidelines
                createEl('div', { className: "space-y-6" }, [
                    createEl('div', { className: "bg-blue-50 border border-blue-100 rounded-xl p-6 shadow-sm sticky top-24" }, [
                        createEl('h4', { className: "text-blue-900 font-bold mb-3 flex items-center gap-2" }, [
                            createEl('i', { 'data-lucide': 'lightbulb', className: 'w-5 h-5 text-blue-600' }), 'Quick Tips'
                        ]),
                        createEl('ul', { className: "text-sm text-blue-800 space-y-3 opacity-90" }, [
                            createEl('li', { className: "flex gap-2" }, [createEl('i', { 'data-lucide': 'check-circle', className: 'w-4 h-4 flex-shrink-0 mt-0.5'}), 'Select your subject first to see specific topic allocations.']),
                            createEl('li', { className: "flex gap-2" }, [createEl('i', { 'data-lucide': 'check-circle', className: 'w-4 h-4 flex-shrink-0 mt-0.5'}), 'Ensure all team members belong to Section 3CSE01.']),
                            createEl('li', { className: "flex gap-2" }, [createEl('i', { 'data-lucide': 'check-circle', className: 'w-4 h-4 flex-shrink-0 mt-0.5'}), 'SRNs are validated against the university database.'])
                        ])
                    ])
                ])
            ]);
        };

        const ProjectSubmission = () => {
            const { selectedSubject, submissionHistory } = appState;
            
            const handleSimulateUpload = (type) => {
                const newEntry = {
                    id: Date.now(),
                    action: `${type} Updated`,
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', month: 'short', day: 'numeric' }),
                    status: "Submitted"
                };
                setState({ submissionHistory: [newEntry, ...submissionHistory] });
            };

            const submissionTypes = [
                { label: "Final Report", icon: 'file-text', desc: "PDF Format only" },
                { label: "PPT Presentation", icon: 'presentation', desc: "Max 15 slides" },
                { label: "Demo Video", icon: 'video', desc: "MP4, Max 5 mins" },
                { label: "GitHub Repo", icon: 'github', desc: "Public link" },
            ];

            // Per-subject stats (deadline and submissions). In a real app this would come from the backend.
            if (!appState.subjectStats) {
                const defaultDeadline = new Date(Date.now() + 5 * 24 * 60 * 60 * 1000 + 4 * 60 * 60 * 1000);
                appState.subjectStats = {};
                SUBJECTS.forEach(s => {
                    appState.subjectStats[s] = {
                        deadline: new Date(defaultDeadline.getTime() + (SUBJECTS.indexOf(s) * 24 * 60 * 60 * 1000)),
                        submissions: Math.floor(Math.random() * 10),
                        lastSubmitted: null
                    };
                });
            }

            return createEl('div', { className: "grid lg:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500" }, [
                createEl('div', { className: "lg:col-span-2 space-y-6" }, [
                    createEl('div', { className: "bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-xl text-white flex items-center justify-between shadow-lg" }, [
                        createEl('div', {}, [
                            createEl('p', { className: "text-xs font-bold text-indigo-100 uppercase tracking-wider mb-1" }, 'Current Workspace'),
                            createEl('h3', { className: "text-2xl font-bold flex items-center gap-2" }, [selectedSubject, createEl('span', { className: "text-xs bg-white/20 px-2 py-1 rounded" }, 'Active')])
                        ]),
                        createEl('div', { className: "h-12 w-12 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm" }, [
                            createEl('i', { 'data-lucide': 'upload', className: 'w-6 h-6 text-white'})
                        ])
                    ]),
                    createEl('div', { className: "grid md:grid-cols-2 gap-4" }, submissionTypes.map((item) => 
                        createEl('div', { key: item.label, className: "bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-lg hover:border-indigo-300 transition-all cursor-pointer group transform hover:-translate-y-1 duration-300" }, [
                            createEl('div', { className: "flex items-start justify-between mb-4" }, [
                                createEl('div', { className: "p-3 bg-indigo-50 group-hover:bg-indigo-600 group-hover:text-white rounded-lg text-indigo-600 transition-colors duration-300" }, [
                                    createEl('i', { 'data-lucide': item.icon, className: 'w-6 h-6' })
                                ]),
                                createEl('span', { className: "bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded-full group-hover:bg-indigo-100 group-hover:text-indigo-700 transition-colors" }, 'Required')
                            ]),
                            createEl('h3', { className: "font-bold text-gray-900 group-hover:text-indigo-700 transition-colors" }, item.label),
                            createEl('p', { className: "text-sm text-gray-500 mb-4" }, item.desc),
                            createEl('button', { 
                                onclick: () => handleSimulateUpload(item.label),
                                className: "w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 group-hover:border-indigo-500 group-hover:bg-indigo-50 group-hover:text-indigo-700 transition-all flex items-center justify-center gap-2 text-sm font-bold"
                            }, [
                                createEl('i', { 'data-lucide': 'upload', className: 'w-4 h-4' }), 'Click to Upload'
                            ])
                        ])
                    ))
                ]),
                createEl('div', { className: "bg-white rounded-xl border border-gray-200 shadow-sm p-6 h-fit sticky top-24" }, [
                    createEl('h3', { className: "text-lg font-bold text-gray-900 mb-4 flex items-center gap-2" }, [
                        createEl('i', { 'data-lucide': 'history', className: 'w-5 h-5 text-indigo-600' }), 'Recent Activity'
                    ]),
                    // Subject Selector
                    createEl('div', { className: "mb-4" }, [
                        createEl('label', { className: "block text-sm font-semibold text-gray-700 mb-2" }, 'Track Subject'),
                        createEl('select', {
                            value: appState.selectedSubject,
                            onchange: (e) => setSelectedSubject(e.target.value),
                            className: "w-full rounded-lg border-gray-300 border p-2.5 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm outline-none appearance-none cursor-pointer"
                        }, SUBJECTS.map(s => createEl('option', { key: s, value: s }, s)))
                    ]),
                    // Subject Stats
                    createEl('div', { className: "mb-4 bg-gray-50 rounded-lg p-3" }, [
                        (() => {
                            const stats = appState.subjectStats[appState.selectedSubject];
                            const daysLeft = Math.max(0, Math.ceil((stats.deadline - new Date()) / (1000 * 60 * 60 * 24)));
                            return createEl('div', { className: "flex flex-col gap-2" }, [
                                createEl('div', { className: "flex items-center justify-between" }, [
                                    createEl('div', {}, [createEl('p', { className: "text-sm text-gray-600" }, `Deadline: ${stats.deadline.toDateString()}`), createEl('p', { className: "text-xs text-gray-500" }, `${daysLeft} days left`)]),
                                    createEl('div', {}, [createEl('p', { className: "text-sm font-bold text-gray-900" }, `${stats.submissions} submissions`), createEl('p', { className: "text-xs text-gray-500" }, stats.lastSubmitted ? `Last: ${stats.lastSubmitted.toDateString()}` : 'No recent submissions')])
                                ]),
                                createEl('div', { className: "flex gap-2" }, [
                                    createEl('button', { onclick: () => {
                                        // Simulate a submission for this subject
                                        const now = new Date();
                                        const update = {...appState.subjectStats};
                                        update[appState.selectedSubject].submissions += 1;
                                        update[appState.selectedSubject].lastSubmitted = now;
                                        setState({ subjectStats: update, submissionHistory: [{ id: Date.now(), action: `${appState.selectedSubject} - Submission`, timestamp: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', month: 'short', day: 'numeric' }), status: 'Submitted' }, ...submissionHistory] });
                                    }, className: "px-3 py-1 bg-indigo-600 text-white rounded text-sm" }, 'Simulate Submission'),
                                    createEl('button', { onclick: () => {
                                        // Extend deadline by 3 days
                                        const update = {...appState.subjectStats};
                                        update[appState.selectedSubject].deadline = new Date(update[appState.selectedSubject].deadline.getTime() + 3 * 24 * 60 * 60 * 1000);
                                        setState({ subjectStats: update });
                                    }, className: "px-3 py-1 border rounded text-sm" }, 'Extend Deadline')
                                ])
                            ]);
                        })()
                    ]),
                    createEl('div', { className: "relative border-l-2 border-gray-100 ml-3 space-y-6" }, submissionHistory.map((item) => 
                        createEl('div', { key: item.id, className: "ml-6 relative group" }, [
                            createEl('div', { className: "absolute -left-[31px] bg-white border-2 border-indigo-100 rounded-full p-1 group-hover:border-indigo-500 transition-colors" }, [
                                createEl('div', { className: "w-2.5 h-2.5 bg-indigo-600 rounded-full group-hover:scale-125 transition-transform" })
                            ]),
                            createEl('div', { className: "flex justify-between items-start" }, [
                                createEl('div', {}, [
                                    createEl('p', { className: "text-sm font-semibold text-gray-900 group-hover:text-indigo-700 transition-colors" }, item.action),
                                    createEl('p', { className: "text-xs text-gray-500 mt-0.5" }, item.timestamp)
                                ]),
                                createEl('span', { className: `text-[10px] font-bold px-2 py-1 rounded-full ${
                                    item.status === 'Verified' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                }` }, item.status)
                            ])
                        ])
                    ))
                ])
            ]);
        };

        const MarksTracking = () => {
            const cards = [
                { title: "Presentation", score: INITIAL_MARKS.presentation, total: 20, icon: 'presentation', color: "text-blue-600", bg: "bg-blue-50" },
                { title: "Assignment", score: INITIAL_MARKS.assignment, total: 10, icon: 'file-text', color: "text-purple-600", bg: "bg-purple-50" },
                { title: "PPT Design", score: INITIAL_MARKS.ppt, total: 10, icon: 'bar-chart-3', color: "text-orange-600", bg: "bg-orange-50" },
                { title: "Final Report", score: INITIAL_MARKS.report, total: 20, icon: 'check-circle', color: "text-green-600", bg: "bg-green-50" },
            ];
            const percentage = (INITIAL_MARKS.total / INITIAL_MARKS.maxTotal) * 100;

            return createEl('div', { className: "space-y-8 animate-in fade-in zoom-in-95 duration-500" }, [
                createEl('div', { className: "bg-indigo-900 rounded-2xl p-8 text-white flex flex-col md:flex-row items-center justify-between shadow-xl relative overflow-hidden group" }, [
                    createEl('div', { className: "absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl -mt-10 -mr-10 group-hover:opacity-10 transition-opacity duration-700" }),
                    createEl('div', { className: "relative z-10" }, [
                        createEl('h2', { className: "text-3xl font-bold mb-2" }, 'Total Score'),
                        createEl('p', { className: "text-indigo-200 font-medium" }, 'Excellent performance! You are in the top 10%.')
                    ]),
                    createEl('div', { className: "mt-6 md:mt-0 flex items-center justify-center relative z-10" }, [
                        createEl('div', { className: "relative w-32 h-32 hover:scale-110 transition-transform duration-300" }, [
                            createEl('svg', { className: "w-full h-full", viewBox: "0 0 36 36" }, [
                                createEl('path', {
                                    className: "text-indigo-800",
                                    d: "M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831",
                                    fill: "none",
                                    stroke: "currentColor",
                                    strokeWidth: "3"
                                }),
                                createEl('path', {
                                    className: "text-white drop-shadow-md",
                                    'stroke-dasharray': `${percentage}, 100`,
                                    d: "M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831",
                                    fill: "none",
                                    stroke: "currentColor",
                                    strokeWidth: "3",
                                    'stroke-linecap': "round"
                                })
                            ]),
                            createEl('div', { className: "absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center" }, [
                                createEl('span', { className: "text-3xl font-bold" }, String(INITIAL_MARKS.total)),
                                createEl('span', { className: "text-xs block opacity-70 font-medium" }, `/ ${INITIAL_MARKS.maxTotal}`)
                            ])
                        ])
                    ])
                ]),
                createEl('div', { className: "grid grid-cols-2 md:grid-cols-4 gap-4" }, cards.map((card) => 
                    createEl('div', { key: card.title, className: "bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center text-center hover:shadow-lg hover:-translate-y-1 transition-all duration-300" }, [
                        createEl('div', { className: `p-4 rounded-full ${card.bg} ${card.color} mb-4 shadow-sm group-hover:scale-110 transition-transform` }, [
                            createEl('i', { 'data-lucide': card.icon, className: 'w-6 h-6' })
                        ]),
                        createEl('h3', { className: "font-semibold text-gray-600 mb-1" }, card.title),
                        createEl('p', { className: "text-3xl font-bold text-gray-900" }, [
                            String(card.score), 
                            createEl('span', { className: "text-sm text-gray-400 font-normal" }, ` / ${card.total}`)
                        ])
                    ])
                ))
            ]);
        };

        const UserProfile = ({ currentUser }) => {
            const pastTeams = [
                { id: 1, semester: "2nd Sem", subject: "Data Structures", team: "StructBuilders", role: "Member", status: "Completed" },
                { id: 2, semester: "1st Sem", subject: "Design Thinking", team: "Innovators", role: "Lead", status: "Completed" },
                { id: 3, semester: "1st Sem", subject: "Python Programming", team: "PyCoders", role: "Member", status: "Completed" },
            ];

            const activityHistory = [
                { id: 1, action: "Logged in", time: "Just now", icon: 'user-plus' },
                { id: 2, action: "Submitted Abstract", time: "Yesterday, 4:00 PM", icon: 'file-text' },
                { id: 3, action: "Joined Team 'Alpha Squad'", time: "2 days ago", icon: 'users' },
                { id: 4, action: "Updated Profile", time: "1 week ago", icon: 'briefcase' },
            ];

            const lastSubmission = {
                title: "Eco-Friendly Smart Bin",
                subject: "Design Thinking",
                date: "May 15, 2024",
                grade: "A+",
                feedback: "Excellent prototype and documentation."
            };

            return createEl('div', { className: "space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500" }, [
                // Header Card
                createEl('div', { className: "bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col md:flex-row items-center gap-6" }, [
                    createEl('div', { className: "w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center text-3xl font-bold text-indigo-700 border-4 border-white shadow-md" }, currentUser.name.charAt(0)),
                    createEl('div', { className: "flex-1 text-center md:text-left" }, [
                        createEl('h2', { className: "text-2xl font-bold text-gray-900" }, currentUser.name),
                        createEl('div', { className: "flex flex-col md:flex-row gap-4 mt-2 text-sm text-gray-500 justify-center md:justify-start" }, [
                            createEl('span', { className: "flex items-center gap-1" }, [createEl('i', { 'data-lucide': 'briefcase', className: 'w-4 h-4'}), ` SRN: ${currentUser.srn}`]),
                            createEl('span', { className: "flex items-center gap-1" }, [createEl('i', { 'data-lucide': 'graduation-cap', className: 'w-4 h-4'}), ` Section: ${currentUser.section}`]),
                            createEl('span', { className: "flex items-center gap-1" }, [createEl('i', { 'data-lucide': 'calendar', className: 'w-4 h-4'}), ' Sem: 3rd'])
                        ])
                    ]),
                    createEl('div', { className: "flex gap-3" }, [
                        createEl('button', { className: "px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg font-medium hover:bg-indigo-100 transition-colors" }, 'Edit Profile')
                    ])
                ]),
                createEl('div', { className: "grid md:grid-cols-2 gap-6" }, [
                    // Last Project Submission
                    createEl('div', { className: "bg-white rounded-xl shadow-sm border border-gray-200 p-6" }, [
                        createEl('h3', { className: "text-lg font-bold text-gray-900 mb-4 flex items-center gap-2" }, [
                            createEl('i', { 'data-lucide': 'file-text', className: 'w-5 h-5 text-indigo-600' }), ' Last Project Submission'
                        ]),
                        createEl('div', { className: "bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl p-5 border border-indigo-100" }, [
                            createEl('div', { className: "flex justify-between items-start mb-2" }, [
                                createEl('div', {}, [
                                    createEl('h4', { className: "font-bold text-indigo-900" }, lastSubmission.title),
                                    createEl('p', { className: "text-sm text-indigo-600" }, lastSubmission.subject)
                                ]),
                                createEl('span', { className: "bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded" }, lastSubmission.grade)
                            ]),
                            createEl('p', { className: "text-xs text-gray-500 mb-4" }, `Submitted on: ${lastSubmission.date}`),
                            createEl('div', { className: "text-sm text-gray-700 bg-white/60 p-3 rounded-lg border border-indigo-50 italic" }, `"${lastSubmission.feedback}"`)
                        ])
                    ]),
                    // My History
                    createEl('div', { className: "bg-white rounded-xl shadow-sm border border-gray-200 p-6" }, [
                        createEl('h3', { className: "text-lg font-bold text-gray-900 mb-4 flex items-center gap-2" }, [
                            createEl('i', { 'data-lucide': 'history', className: 'w-5 h-5 text-orange-500' }), ' Recent Activity'
                        ]),
                        createEl('div', { className: "space-y-4" }, activityHistory.map((item) => 
                            createEl('div', { key: item.id, className: "flex items-center gap-3 pb-3 border-b border-gray-50 last:border-0 last:pb-0" }, [
                                createEl('div', { className: "p-2 bg-gray-50 rounded-full text-gray-500" }, [
                                    createEl('i', { 'data-lucide': 'user-plus', className: 'w-4 h-4' })
                                ]),
                                createEl('div', { className: "flex-1" }, [
                                    createEl('p', { className: "text-sm font-medium text-gray-800" }, item.action),
                                    createEl('p', { className: "text-xs text-gray-400" }, item.time)
                                ])
                            ])
                        ))
                    ]),
                    // Past Team Formation
                    createEl('div', { className: "md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6" }, [
                        createEl('h3', { className: "text-lg font-bold text-gray-900 mb-4 flex items-center gap-2" }, [
                            createEl('i', { 'data-lucide': 'users', className: 'w-5 h-5 text-blue-600' }), ' Past Team Formations'
                        ]),
                        createEl('div', { className: "overflow-x-auto" }, [
                            createEl('table', { className: "w-full text-left text-sm" }, [
                                createEl('thead', { className: "bg-gray-50 text-gray-500 font-semibold uppercase tracking-wider text-xs" }, [
                                    createEl('tr', {}, [
                                        createEl('th', { className: "px-4 py-3" }, 'Semester'),
                                        createEl('th', { className: "px-4 py-3" }, 'Subject'),
                                        createEl('th', { className: "px-4 py-3" }, 'Team Name'),
                                        createEl('th', { className: "px-4 py-3" }, 'Role'),
                                        createEl('th', { className: "px-4 py-3" }, 'Status'),
                                    ])
                                ]),
                                createEl('tbody', { className: "divide-y divide-gray-100" }, pastTeams.map((team) => 
                                    createEl('tr', { key: team.id, className: "hover:bg-gray-50" }, [
                                        createEl('td', { className: "px-4 py-3 font-medium text-gray-900" }, team.semester),
                                        createEl('td', { className: "px-4 py-3 text-gray-600" }, team.subject),
                                        createEl('td', { className: "px-4 py-3 text-indigo-600 font-medium" }, team.team),
                                        createEl('td', { className: "px-4 py-3" }, [
                                            createEl('span', { className: `text-xs px-2 py-1 rounded-full border ${team.role === 'Lead' ? 'bg-purple-50 text-purple-700 border-purple-100' : 'bg-gray-50 text-gray-700 border-gray-100'}` }, team.role)
                                        ]),
                                        createEl('td', { className: "px-4 py-3 text-green-600 flex items-center gap-1" }, [
                                            createEl('i', { 'data-lucide': 'check-circle', className: 'w-3 h-3' }), team.status
                                        ])
                                    ])
                                ))
                            ])
                        ])
                    ])
                ])
            ]);
        };

        // ----------------------------------------------------
        // 4. Main Render Function
        // ----------------------------------------------------
        const renderContent = () => {
            const { activeTab, currentUser, selectedSubject } = appState;
            let content;

            switch (activeTab) {
                case 'team':
                    content = TeamFormation({ currentUser, onOpenAI: handleOpenAI });
                    break;
                case 'submissions':
                    content = ProjectSubmission();
                    break;
                case 'marks':
                    content = MarksTracking();
                    break;
                case 'profile':
                    content = UserProfile({ currentUser });
                    break;
                case 'dashboard':
                default:
                    content = createEl('div', { className: "space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-700" }, [
                        WelcomeBanner({ userName: currentUser.name }),
                        DueTimer(),
                        createEl('div', { className: "grid lg:grid-cols-2 gap-6" }, [
                            createEl('div', { className: "flex flex-col gap-6" }, [
                                createEl('div', { className: "bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow" }, [
                                    createEl('h3', { className: "text-lg font-bold text-gray-800 mb-4 flex justify-between items-center" }, [
                                        'Submission Status',
                                        createEl('span', { className: "text-xs font-medium bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full" }, selectedSubject)
                                    ]),
                                    createEl('div', { className: "space-y-4" }, [
                                        createEl('div', { className: "flex justify-between items-center pb-4 border-b border-gray-100 group" }, [
                                            createEl('span', { className: "text-gray-600 font-medium group-hover:text-gray-900 transition-colors" }, 'Phase 1: Abstract'),
                                            createEl('span', { className: "text-green-600 font-bold text-sm flex items-center gap-1 bg-green-50 px-2 py-1 rounded" }, [createEl('i', { 'data-lucide': 'check-circle', className: 'w-4 h-4'}), ' Done'])
                                        ]),
                                        createEl('div', { className: "flex justify-between items-center pb-4 border-b border-gray-100 group" }, [
                                            createEl('span', { className: "text-gray-600 font-medium group-hover:text-gray-900 transition-colors" }, 'Phase 2: Design Doc'),
                                            createEl('span', { className: "text-green-600 font-bold text-sm flex items-center gap-1 bg-green-50 px-2 py-1 rounded" }, [createEl('i', { 'data-lucide': 'check-circle', className: 'w-4 h-4'}), ' Done'])
                                        ]),
                                        createEl('div', { className: "flex justify-between items-center group" }, [
                                            createEl('span', { className: "text-gray-900 font-bold" }, 'Phase 3: Final Report'),
                                            createEl('span', { className: "text-orange-600 font-bold text-sm flex items-center gap-1 bg-orange-50 px-2 py-1 rounded animate-pulse" }, [createEl('i', { 'data-lucide': 'clock', className: 'w-4 h-4'}), ' Pending'])
                                        ])
                                    ])
                                ])
                            ]),
                            Leaderboard()
                        ])
                    ]);
                    break;
            }

            return createEl('main', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" }, [
                // Header (Breadcrumb style)
                activeTab !== 'dashboard' && createEl('div', { className: "mb-8 animate-in fade-in slide-in-from-left-4 duration-500" }, [
                    createEl('h1', { className: "text-3xl font-bold text-gray-900 capitalize tracking-tight flex items-center gap-2" }, activeTab.replace('-', ' ')),
                    createEl('p', { className: "text-base text-gray-500 mt-1" }, 
                        activeTab === 'team' ? 'Configure your project parameters and assemble your team.' : 
                        activeTab === 'profile' ? 'View your personal academic history and status.' :
                        `Manage your ${activeTab} details.`
                    )
                ]),
                content
            ]);
        };

        const renderApp = () => {
            const app = document.getElementById('app');
            
            try {
                app.innerHTML = ''; // Clear previous content

                const { activeTab, currentUser, selectedSubject } = appState;
                const nav = Navigation({ activeTab, setActiveTab, userName: currentUser.name });
                const mainContent = renderContent();
                const aiAssistant = AIAssistant();

                app.appendChild(nav);
                app.appendChild(mainContent);
                app.appendChild(aiAssistant);

                // Re-initialize Lucide icons after rendering new DOM elements
                lucide.createIcons();
            } catch (error) {
                console.error("Rendering Error:", error);
                app.innerHTML = `
                    <div class="h-screen flex flex-col items-center justify-center text-red-600 p-8">
                        <i data-lucide="alert-triangle" class="w-12 h-12 mb-4"></i>
                        <h2 class="text-xl font-bold">Application Failed to Render</h2>
                        <p class="text-sm text-gray-500 mt-2">A critical error occurred. Please check the console for details.</p>
                        <p class="text-xs text-gray-400 mt-1">${error.message}</p>
                    </div>
                `;
                // Ensure the error icon renders if Lucide is available
                lucide.createIcons();
            }
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            // Start the timer update interval
            window.timerInterval = setInterval(updateTimer, 1000);

            // Initial render
            renderApp();
        };

        // Cleanup on window unload (optional, for completeness)
        window.onunload = () => {
            if (window.timerInterval) {
                clearInterval(window.timerInterval);
            }
        };
    </script>
</body>
</html>